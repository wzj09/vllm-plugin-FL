name: UT & E2E (Label Driven)

on:
  push:
    branches: ["test_ut"]
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, labeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dev dependencies
        run: |
          pip install -r requirements-dev.txt

      - name: Run pre-commit
        run: |
          pre-commit run --all-files

  changes:
    runs-on: ubuntu-latest
    outputs:
      ut_changed: ${{ steps.filter.outputs.ut }}
      e2e_changed: ${{ steps.filter.outputs.e2e }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            ut:
              - '.github/workflows/ut-e2e.yml'
              - 'vllm_fl/**'
              - 'tests/ut/**'
              - 'setup.py'
              - 'requirements.txt'
            e2e:
              - 'tests/e2e/**'
              - 'examples/**'
              - 'vllm_fl/**'

  ut:
    name: Unit Tests
    needs: [lint, changes]
    if: |
      needs.lint.result == 'success' &&
      needs.changes.outputs.ut_changed == 'true' &&
      (
        github.event_name == 'push' ||
        (
          github.event_name == 'pull_request' &&
          contains(github.event.pull_request.labels.*.name, 'ut')
        )
      )
    runs-on: [self-hosted, Linux, X64, nvidia-0, gpus-8]
    steps:
      - uses: actions/checkout@v4

      - name: Run UT (docker)
        run: |
          docker run --rm \
            -u $(id -u):$(id -g) \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            localhost:5000/vllm-plugin-fl:ci \
            bash -c "
              set -e &&
              pip install -r requirements.txt &&
              pip install --no-build-isolation -e . &&
              pytest tests/ut
            "

  e2e:
    name: E2E Tests
    needs: [lint, changes]
    if: |
      needs.lint.result == 'success' &&
      needs.changes.outputs.e2e_changed == 'true' &&
      (
        github.event_name == 'push' ||
        (
          github.event_name == 'pull_request' &&
          contains(github.event.pull_request.labels.*.name, 'e2e')
        )
      )
    runs-on: [self-hosted, Linux, X64, nvidia-0, gpus-8]
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4

      - name: Run E2E (docker)
        run: |
          docker run --rm \
            -u $(id -u):$(id -g) \
            -v ${{ github.workspace }}:/workspace \
            -v /home/flagscale_cicd/docker/docker_build/docker_data:/home/gitlab-runner/data
            -w /workspace \
            localhost:5000/vllm-plugin-fl:ci \
            bash -c "
              set -e &&
              pip install -r requirements.txt &&
              pip install --no-build-isolation -e . &&
              pytest tests/e2e
            "

